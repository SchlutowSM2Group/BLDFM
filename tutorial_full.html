<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Full tutorial &#8212; BLDFM 1.0.0-dev documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=89e598d8" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=56c4699f" />
    <script src="_static/documentation_options.js?v=8313637b"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Quick reference" href="reference.html" />
    <link rel="prev" title="Quickstart tutorial" href="tutorial_quickstart.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo.png" alt="Logo" />
    
    <h1 class="logo logo-name">BLDFM</h1>
    
  </a>
</p>



<p class="blurb">A Python dispersion and footprint model</p>






<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_quickstart.html">Quickstart tutorial</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Full tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-simulations">Running simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-results">Working with results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#i-o-and-caching">I/O and caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualization">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#low-level-api">Low-level API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#command-line-interface">Command-line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#further-resources">Further resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Quick reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Package overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="src.html">API reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/SchlutowSM2Group/BLDFM">GitHub repository</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="runs.html">Example scripts and workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests.html">The <code class="docutils literal notranslate"><span class="pre">tests</span></code> subpackage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="genindex.html">Glossary Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="py-modindex.html">Module Index</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tutorial_quickstart.html" title="previous chapter">Quickstart tutorial</a></li>
      <li>Next: <a href="reference.html" title="next chapter">Quick reference</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="tutorial_quickstart.html" title="Previous document">Quickstart tutorial</a>
        </li>
        <li>
          <a href="reference.html" title="Next document">Quick reference</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section id="full-tutorial">
<h1>Full tutorial<a class="headerlink" href="#full-tutorial" title="Link to this heading">¶</a></h1>
<p>This tutorial covers every major BLDFM capability, organized by what you want
to accomplish.  It assumes you have completed the <a class="reference internal" href="tutorial_quickstart.html"><span class="doc">Quickstart tutorial</span></a>
and have BLDFM installed.</p>
<nav class="contents local" id="sections">
<p class="topic-title">Sections</p>
<ul class="simple">
<li><p><a class="reference internal" href="#prerequisites" id="id2">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#configuration" id="id3">Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#loading-a-yaml-config" id="id4">Loading a YAML config</a></p></li>
<li><p><a class="reference internal" href="#building-a-config-in-python" id="id5">Building a config in Python</a></p></li>
<li><p><a class="reference internal" href="#config-schema-reference" id="id6">Config schema reference</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#running-simulations" id="id7">Running simulations</a></p>
<ul>
<li><p><a class="reference internal" href="#single-solve" id="id8">Single solve</a></p></li>
<li><p><a class="reference internal" href="#timeseries" id="id9">Timeseries</a></p></li>
<li><p><a class="reference internal" href="#multi-tower" id="id10">Multi-tower</a></p></li>
<li><p><a class="reference internal" href="#parallel-execution" id="id11">Parallel execution</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#working-with-results" id="id12">Working with results</a></p>
<ul>
<li><p><a class="reference internal" href="#percentile-contours" id="id13">Percentile contours</a></p></li>
<li><p><a class="reference internal" href="#source-area-analysis" id="id14">Source area analysis</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#i-o-and-caching" id="id15">I/O and caching</a></p>
<ul>
<li><p><a class="reference internal" href="#netcdf-export-and-import" id="id16">NetCDF export and import</a></p></li>
<li><p><a class="reference internal" href="#green-s-function-caching" id="id17">Green’s function caching</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#visualization" id="id18">Visualization</a></p>
<ul>
<li><p><a class="reference internal" href="#footprint-field" id="id19">Footprint field</a></p></li>
<li><p><a class="reference internal" href="#map-overlay-requires-contextily" id="id20">Map overlay (requires contextily)</a></p></li>
<li><p><a class="reference internal" href="#wind-rose-requires-windrose" id="id21">Wind rose (requires windrose)</a></p></li>
<li><p><a class="reference internal" href="#footprint-timeseries" id="id22">Footprint timeseries</a></p></li>
<li><p><a class="reference internal" href="#source-area-contour-plots" id="id23">Source area contour plots</a></p></li>
<li><p><a class="reference internal" href="#interactive-plot-requires-plotly" id="id24">Interactive plot (requires plotly)</a></p></li>
<li><p><a class="reference internal" href="#diagnostic-plots" id="id25">Diagnostic plots</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#low-level-api" id="id26">Low-level API</a></p></li>
<li><p><a class="reference internal" href="#command-line-interface" id="id27">Command-line interface</a></p></li>
<li><p><a class="reference internal" href="#further-resources" id="id28">Further resources</a></p></li>
</ul>
</nav>
<section id="prerequisites">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev,plotting]&quot;</span>
</pre></div>
</div>
<p>All code below assumes you are in the repository root and have an active Python
session.  Small grid sizes are used throughout for fast execution.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bldfm</span>
<span class="n">bldfm</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="configuration">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Configuration</a><a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h2>
<p>BLDFM configurations define the computational domain, tower positions,
meteorological forcing, and solver settings.  You can load configs from YAML
files or build them programmatically in Python.</p>
<section id="loading-a-yaml-config">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Loading a YAML config</a><a class="headerlink" href="#loading-a-yaml-config" title="Link to this heading">¶</a></h3>
<p>BLDFM ships with several example configs in <code class="docutils literal notranslate"><span class="pre">examples/configs/</span></code>.
<code class="docutils literal notranslate"><span class="pre">load_config()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">BLDFMConfig</span></code> dataclass:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">bldfm</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s2">&quot;examples/configs/footprint.yaml&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">nx</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">ny</span><span class="si">}</span><span class="s2">, nz=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">nz</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tower: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, z_m=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z_m</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solver: closure=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">closure</span><span class="si">}</span><span class="s2">, footprint=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">footprint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="building-a-config-in-python">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Building a config in Python</a><a class="headerlink" href="#building-a-config-in-python" title="Link to this heading">¶</a></h3>
<p>For programmatic workflows – parameter sweeps, scripted experiments – use
<code class="docutils literal notranslate"><span class="pre">parse_config_dict()</span></code> with a plain Python dictionary that mirrors the YAML
structure.  When <code class="docutils literal notranslate"><span class="pre">ref_lat</span></code>/<code class="docutils literal notranslate"><span class="pre">ref_lon</span></code> are set, each tower’s local <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y)</span></code>
coordinates are computed automatically from its <code class="docutils literal notranslate"><span class="pre">(lat,</span> <span class="pre">lon)</span></code> via an
equirectangular projection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_config_dict</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">parse_config_dict</span><span class="p">({</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;nx&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="mf">250.0</span><span class="p">,</span> <span class="s2">&quot;nz&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s2">&quot;ref_lat&quot;</span><span class="p">:</span> <span class="mf">50.95</span><span class="p">,</span> <span class="s2">&quot;ref_lon&quot;</span><span class="p">:</span> <span class="mf">11.586</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;towers&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tower_A&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">50.9505</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">11.5865</span><span class="p">,</span> <span class="s2">&quot;z_m&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">}],</span>
    <span class="s2">&quot;met&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ustar&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s2">&quot;mol&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">,</span> <span class="s2">&quot;wind_speed&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;wind_dir&quot;</span><span class="p">:</span> <span class="mf">270.0</span><span class="p">},</span>
    <span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;closure&quot;</span><span class="p">:</span> <span class="s2">&quot;MOST&quot;</span><span class="p">,</span> <span class="s2">&quot;footprint&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tower local coords: x=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m, y=</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> m&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="config-schema-reference">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Config schema reference</a><a class="headerlink" href="#config-schema-reference" title="Link to this heading">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">BLDFMConfig</span></code> contains six sub-configs:</p>
<p><strong>DomainConfig</strong> – computational grid geometry.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code>: grid points in x (cross-wind) and y (along-wind)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nz</span></code>: number of vertical levels</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xmax</span></code>, <code class="docutils literal notranslate"><span class="pre">ymax</span></code>: domain extent in metres</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">modes</span></code>: Fourier modes <code class="docutils literal notranslate"><span class="pre">[kx,</span> <span class="pre">ky]</span></code>; higher values improve accuracy</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">halo</span></code>: zero-padding width (metres) to reduce spectral leakage</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ref_lat</span></code>, <code class="docutils literal notranslate"><span class="pre">ref_lon</span></code>: reference origin for lat/lon to local coordinate conversion</p></li>
</ul>
<p><strong>TowerConfig</strong> – measurement tower location.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">lat</span></code>, <code class="docutils literal notranslate"><span class="pre">lon</span></code>, <code class="docutils literal notranslate"><span class="pre">z_m</span></code>: tower identity, coordinates, and height</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>: local coordinates (auto-computed from <code class="docutils literal notranslate"><span class="pre">ref_lat</span></code>/<code class="docutils literal notranslate"><span class="pre">ref_lon</span></code>)</p></li>
</ul>
<p><strong>MetConfig</strong> – meteorological forcing.  Use scalars for a single timestep
or lists of equal length for a timeseries.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ustar</span></code>: friction velocity (m/s).  Provide <em>either</em> <code class="docutils literal notranslate"><span class="pre">ustar</span></code> or <code class="docutils literal notranslate"><span class="pre">z0</span></code>,
not both.  When <code class="docutils literal notranslate"><span class="pre">z0</span></code> (roughness length) is given, the model derives
<code class="docutils literal notranslate"><span class="pre">ustar</span></code> internally via the PBL closure.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mol</span></code>: Monin-Obukhov length (m).  Negative = unstable (daytime convection),
positive = stable (nighttime), very large (~1e9) = neutral.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wind_speed</span></code>, <code class="docutils literal notranslate"><span class="pre">wind_dir</span></code>: horizontal wind speed (m/s) and direction
(degrees; 0 = N, 90 = E, 180 = S, 270 = W).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamps</span></code>: optional list of timestamp labels for each timestep.</p></li>
</ul>
<p><strong>SolverConfig</strong> – numerical solver settings.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">closure</span></code>: PBL closure scheme – <code class="docutils literal notranslate"><span class="pre">MOST</span></code>, <code class="docutils literal notranslate"><span class="pre">MOSTM</span></code>, <code class="docutils literal notranslate"><span class="pre">CONSTANT</span></code>, or <code class="docutils literal notranslate"><span class="pre">OAAHOC</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">footprint</span></code>: <code class="docutils literal notranslate"><span class="pre">true</span></code> computes a flux footprint (Green’s function at
measurement height); <code class="docutils literal notranslate"><span class="pre">false</span></code> computes a concentration field from a
surface source.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">precision</span></code>: <code class="docutils literal notranslate"><span class="pre">single</span></code> or <code class="docutils literal notranslate"><span class="pre">double</span></code> floating-point arithmetic.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">analytic</span></code>: if <code class="docutils literal notranslate"><span class="pre">true</span></code>, uses the Kormann-Meixner analytical footprint
model for comparison.</p></li>
</ul>
<p><strong>OutputConfig</strong> – output format and directory.</p>
<p><strong>ParallelConfig</strong> – parallelism settings.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">num_threads</span></code>: BLAS/numba threads per worker.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_workers</span></code>: number of parallel worker processes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">use_cache</span></code>: enable disk-based solver result caching.</p></li>
</ul>
</section>
</section>
<section id="running-simulations">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Running simulations</a><a class="headerlink" href="#running-simulations" title="Link to this heading">¶</a></h2>
<p>BLDFM provides four functions at progressive levels of complexity, from
a single solve to fully parallel multi-tower timeseries.</p>
<section id="single-solve">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Single solve</a><a class="headerlink" href="#single-solve" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">run_bldfm_single()</span></code> is the fundamental building block.  It takes a config
and a tower, runs one timestep, and returns a result dictionary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_bldfm_single</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">run_bldfm_single</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Footprint shape: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;flx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># (ny, nx)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Met used: wind_speed=</span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;wind_speed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result dict contains:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">grid</span></code>: tuple of <code class="docutils literal notranslate"><span class="pre">(X,</span> <span class="pre">Y,</span> <span class="pre">Z)</span></code> coordinate arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flx</span></code>: 2D flux footprint field, shape <code class="docutils literal notranslate"><span class="pre">(ny,</span> <span class="pre">nx)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">conc</span></code>: 2D concentration field</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tower_name</span></code>, <code class="docutils literal notranslate"><span class="pre">tower_xy</span></code>: tower identity and local coordinates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code>: timestep label or index</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>: dict of meteorological parameters used for this solve</p></li>
</ul>
</section>
<section id="timeseries">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Timeseries</a><a class="headerlink" href="#timeseries" title="Link to this heading">¶</a></h3>
<p>For time-varying meteorology, provide lists in the met config.
<code class="docutils literal notranslate"><span class="pre">run_bldfm_timeseries()</span></code> loops over all timesteps for a single tower and
returns a list of result dicts.  Use <code class="docutils literal notranslate"><span class="pre">generate_synthetic_timeseries()</span></code> to
create reproducible test data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_bldfm_timeseries</span><span class="p">,</span> <span class="n">generate_synthetic_timeseries</span>

<span class="n">met</span> <span class="o">=</span> <span class="n">generate_synthetic_timeseries</span><span class="p">(</span><span class="n">n_timesteps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">config_ts</span> <span class="o">=</span> <span class="n">parse_config_dict</span><span class="p">({</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;nx&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="mf">250.0</span><span class="p">,</span> <span class="s2">&quot;nz&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s2">&quot;ref_lat&quot;</span><span class="p">:</span> <span class="mf">50.95</span><span class="p">,</span> <span class="s2">&quot;ref_lon&quot;</span><span class="p">:</span> <span class="mf">11.586</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;towers&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tower_A&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">50.9505</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">11.5865</span><span class="p">,</span> <span class="s2">&quot;z_m&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">}],</span>
    <span class="s2">&quot;met&quot;</span><span class="p">:</span> <span class="n">met</span><span class="p">,</span>
    <span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;closure&quot;</span><span class="p">:</span> <span class="s2">&quot;MOST&quot;</span><span class="p">,</span> <span class="s2">&quot;footprint&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="p">})</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">run_bldfm_timeseries</span><span class="p">(</span><span class="n">config_ts</span><span class="p">,</span> <span class="n">config_ts</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timesteps computed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  t=</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: max flux = </span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;flx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="multi-tower">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Multi-tower</a><a class="headerlink" href="#multi-tower" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">run_bldfm_multitower()</span></code> runs all towers across all timesteps, returning a
dict of <code class="docutils literal notranslate"><span class="pre">{tower_name:</span> <span class="pre">[result,</span> <span class="pre">...]}</span></code>.  Use <code class="docutils literal notranslate"><span class="pre">generate_towers_grid()</span></code> to
create synthetic tower layouts (<code class="docutils literal notranslate"><span class="pre">&quot;grid&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;transect&quot;</span></code>, or <code class="docutils literal notranslate"><span class="pre">&quot;random&quot;</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_bldfm_multitower</span><span class="p">,</span> <span class="n">generate_towers_grid</span>

<span class="n">towers</span> <span class="o">=</span> <span class="n">generate_towers_grid</span><span class="p">(</span><span class="n">n_towers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_m</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;transect&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">config_mt</span> <span class="o">=</span> <span class="n">parse_config_dict</span><span class="p">({</span>
    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;nx&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span> <span class="s2">&quot;ny&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span> <span class="s2">&quot;xmax&quot;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span> <span class="s2">&quot;ymax&quot;</span><span class="p">:</span> <span class="mf">250.0</span><span class="p">,</span> <span class="s2">&quot;nz&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
        <span class="s2">&quot;ref_lat&quot;</span><span class="p">:</span> <span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">],</span> <span class="s2">&quot;ref_lon&quot;</span><span class="p">:</span> <span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lon&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s2">&quot;towers&quot;</span><span class="p">:</span> <span class="n">towers</span><span class="p">,</span>
    <span class="s2">&quot;met&quot;</span><span class="p">:</span> <span class="n">met</span><span class="p">,</span>
    <span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;closure&quot;</span><span class="p">:</span> <span class="s2">&quot;MOST&quot;</span><span class="p">,</span> <span class="s2">&quot;footprint&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="p">})</span>

<span class="n">all_results</span> <span class="o">=</span> <span class="n">run_bldfm_multitower</span><span class="p">(</span><span class="n">config_mt</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_list</span> <span class="ow">in</span> <span class="n">all_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">res_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> timesteps&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="parallel-execution">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Parallel execution</a><a class="headerlink" href="#parallel-execution" title="Link to this heading">¶</a></h3>
<p>For large runs, <code class="docutils literal notranslate"><span class="pre">run_bldfm_parallel()</span></code> distributes work across CPU cores
using <code class="docutils literal notranslate"><span class="pre">ProcessPoolExecutor</span></code>.  Three strategies are available:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;towers&quot;</span></code>: each worker handles one tower’s full timeseries</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;time&quot;</span></code>: distribute timesteps across workers (per tower)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;both&quot;</span></code>: flatten all tower x timestep pairs across workers</p></li>
</ul>
<p>Each subprocess automatically sets <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS=1</span></code> to avoid CPU
oversubscription.  The return format is identical to <code class="docutils literal notranslate"><span class="pre">run_bldfm_multitower()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_bldfm_parallel</span>

<span class="n">par_results</span> <span class="o">=</span> <span class="n">run_bldfm_parallel</span><span class="p">(</span><span class="n">config_mt</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">parallel_over</span><span class="o">=</span><span class="s2">&quot;towers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="working-with-results">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Working with results</a><a class="headerlink" href="#working-with-results" title="Link to this heading">¶</a></h2>
<p>Solver results are plain Python dictionaries containing NumPy arrays.  This
section covers common post-processing tasks.</p>
<section id="percentile-contours">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Percentile contours</a><a class="headerlink" href="#percentile-contours" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">extract_percentile_contour()</span></code> computes the contour level that encloses a
given fraction of the cumulative footprint, along with the corresponding
area in square metres.  This is useful for quantifying the spatial extent of
the source area (e.g., “the 80 % source area covers 5000 m<sup>2</sup>“):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">extract_percentile_contour</span>

<span class="n">level_50</span><span class="p">,</span> <span class="n">area_50</span> <span class="o">=</span> <span class="n">extract_percentile_contour</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="n">pct</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">level_80</span><span class="p">,</span> <span class="n">area_80</span> <span class="o">=</span> <span class="n">extract_percentile_contour</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="n">pct</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;50% contour: level=</span><span class="si">{</span><span class="n">level_50</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, area=</span><span class="si">{</span><span class="n">area_50</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> m^2&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;80% contour: level=</span><span class="si">{</span><span class="n">level_80</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, area=</span><span class="si">{</span><span class="n">area_80</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> m^2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The 80 % area will always be larger than the 50 % area (it encloses more of
the footprint), while the 50 % contour level will be higher (it represents a
more concentrated core).</p>
</section>
<section id="source-area-analysis">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Source area analysis</a><a class="headerlink" href="#source-area-analysis" title="Link to this heading">¶</a></h3>
<p>BLDFM provides five base functions for characterizing which spatial regions
contribute to the measured flux.  Each constructs a weighting surface <code class="docutils literal notranslate"><span class="pre">g</span></code>
that, combined with the footprint via <code class="docutils literal notranslate"><span class="pre">get_source_area(flx,</span> <span class="pre">g)</span></code>, produces
contours of a specific geometric type:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">source_area_contribution</span></code>: isopleth contours (standard footprint levels)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source_area_circular</span></code>: concentric circles centred on the tower</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source_area_upwind</span></code>: upwind distance bands</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source_area_crosswind</span></code>: crosswind ridge contours</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">source_area_sector</span></code>: angular sectors from the upwind axis</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_source_area</span><span class="p">,</span> <span class="n">source_area_circular</span>

<span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
<span class="n">meas_pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">source_area_circular</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">meas_pt</span><span class="p">)</span>
<span class="n">rescaled</span> <span class="o">=</span> <span class="n">get_source_area</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">runs/low_level/source_area_example.py</span></code> for a complete working example
with all five contour types.</p>
</section>
</section>
<section id="i-o-and-caching">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">I/O and caching</a><a class="headerlink" href="#i-o-and-caching" title="Link to this heading">¶</a></h2>
<section id="netcdf-export-and-import">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">NetCDF export and import</a><a class="headerlink" href="#netcdf-export-and-import" title="Link to this heading">¶</a></h3>
<p>Save multi-tower results to CF-1.8 compliant NetCDF files and load them back
as an <code class="docutils literal notranslate"><span class="pre">xr.Dataset</span></code>.  The file includes footprint and concentration fields,
meteorological metadata, tower coordinates, and global attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_footprints_to_netcdf</span><span class="p">,</span> <span class="n">load_footprints_from_netcdf</span>

<span class="n">save_footprints_to_netcdf</span><span class="p">(</span><span class="n">all_results</span><span class="p">,</span> <span class="n">config_mt</span><span class="p">,</span> <span class="s2">&quot;output/footprints.nc&quot;</span><span class="p">)</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">load_footprints_from_netcdf</span><span class="p">(</span><span class="s2">&quot;output/footprints.nc&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dimensions: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">sizes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variables: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CF Convention: </span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;Conventions&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="green-s-function-caching">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Green’s function caching</a><a class="headerlink" href="#green-s-function-caching" title="Link to this heading">¶</a></h3>
<p>In footprint mode, the solver output (Green’s function) depends only on
vertical profiles and domain geometry – not on the surface flux.  The
<code class="docutils literal notranslate"><span class="pre">GreensFunctionCache</span></code> stores results as SHA-256-keyed <code class="docutils literal notranslate"><span class="pre">.npz</span></code> files so
that identical configurations skip the solver entirely:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">GreensFunctionCache</span><span class="p">,</span> <span class="n">run_bldfm_single</span>

<span class="n">cache</span> <span class="o">=</span> <span class="n">GreensFunctionCache</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="s2">&quot;.bldfm_cache&quot;</span><span class="p">)</span>

<span class="n">result1</span> <span class="o">=</span> <span class="n">run_bldfm_single</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>  <span class="c1"># cache miss</span>
<span class="n">result2</span> <span class="o">=</span> <span class="n">run_bldfm_single</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>  <span class="c1"># cache hit (fast)</span>

<span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clean up</span>
</pre></div>
</div>
<p>Caching can also be enabled globally via <code class="docutils literal notranslate"><span class="pre">parallel.use_cache:</span> <span class="pre">true</span></code> in the
YAML config.</p>
</section>
</section>
<section id="visualization">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Visualization</a><a class="headerlink" href="#visualization" title="Link to this heading">¶</a></h2>
<p>BLDFM includes plotting functions for footprint fields, geospatial overlays,
wind roses, time series, source area contours, diagnostics, and interactive
HTML plots.  Core plots require only matplotlib; optional dependencies are
imported lazily and produce helpful messages when missing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>          <span class="c1"># remove for interactive display</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</pre></div>
</div>
<section id="footprint-field">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Footprint field</a><a class="headerlink" href="#footprint-field" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_footprint_field()</span></code> renders a 2D pcolormesh with optional percentile
contour overlays.  It works for both footprint and concentration fields:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_footprint_field</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_footprint_field</span><span class="p">(</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span>
    <span class="n">contour_pcts</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Footprint with 50</span><span class="si">% a</span><span class="s2">nd 80</span><span class="si">% c</span><span class="s2">ontours&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_contours.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="map-overlay-requires-contextily">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Map overlay (requires contextily)</a><a class="headerlink" href="#map-overlay-requires-contextily" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_footprint_on_map()</span></code> overlays footprint contours and tower markers on
web map tiles.  Set <code class="docutils literal notranslate"><span class="pre">land_cover=True</span></code> to use ESA WorldCover 2021 instead of
street maps (requires owslib):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_footprint_on_map</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_footprint_on_map</span><span class="p">(</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">,</span>
        <span class="n">tower</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">contour_pcts</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_map.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Install contextily for map overlays: pip install contextily&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="wind-rose-requires-windrose">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Wind rose (requires windrose)</a><a class="headerlink" href="#wind-rose-requires-windrose" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_wind_rose()</span></code> creates a polar wind rose from wind speed and direction
arrays:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_wind_rose</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_wind_rose</span><span class="p">(</span>
        <span class="n">met</span><span class="p">[</span><span class="s2">&quot;wind_speed&quot;</span><span class="p">],</span> <span class="n">met</span><span class="p">[</span><span class="s2">&quot;wind_dir&quot;</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Synthetic wind rose&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_windrose.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Install windrose: pip install windrose&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="footprint-timeseries">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Footprint timeseries</a><a class="headerlink" href="#footprint-timeseries" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_footprint_timeseries()</span></code> tracks how footprint extent (area at given
percentiles) changes across timesteps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_footprint_timeseries</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_footprint_timeseries</span><span class="p">(</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span>
    <span class="n">pcts</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Footprint area evolution&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_timeseries.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="source-area-contour-plots">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Source area contour plots</a><a class="headerlink" href="#source-area-contour-plots" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_source_area_gallery()</span></code> produces a multi-panel figure showing all five
source area base function types side by side:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm.plotting</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_source_area_gallery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_wind_fields</span>

<span class="n">meas_pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">towers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
<span class="n">wind</span> <span class="o">=</span> <span class="n">compute_wind_fields</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">270.0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot_source_area_gallery</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="n">meas_pt</span><span class="p">,</span> <span class="n">wind</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_source_gallery.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="interactive-plot-requires-plotly">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">Interactive plot (requires plotly)</a><a class="headerlink" href="#interactive-plot-requires-plotly" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">plot_footprint_interactive()</span></code> creates a Plotly figure that can be saved as
HTML for exploration in a browser:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_footprint_interactive</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_footprint_interactive</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;flx&quot;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">write_html</span><span class="p">(</span><span class="s2">&quot;plots/tutorial_interactive.html&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Install plotly: pip install plotly&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="diagnostic-plots">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Diagnostic plots</a><a class="headerlink" href="#diagnostic-plots" title="Link to this heading">¶</a></h3>
<p>Three functions are available for inspecting solver behaviour and vertical
structure: <code class="docutils literal notranslate"><span class="pre">plot_convergence()</span></code>, <code class="docutils literal notranslate"><span class="pre">plot_vertical_profiles()</span></code>, and
<code class="docutils literal notranslate"><span class="pre">plot_vertical_slice()</span></code>.  See the <a class="reference external" href="src.html">API Reference</a> for full
signatures and usage.</p>
</section>
</section>
<section id="low-level-api">
<h2><a class="toc-backref" href="#id26" role="doc-backlink">Low-level API</a><a class="headerlink" href="#low-level-api" title="Link to this heading">¶</a></h2>
<p>For full control over every step of the simulation, you can call the solver
pipeline directly.  The high-level <code class="docutils literal notranslate"><span class="pre">run_bldfm_single()</span></code> wraps three steps:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compute_wind_fields(speed,</span> <span class="pre">direction)</span></code> – decompose wind into <code class="docutils literal notranslate"><span class="pre">(u,</span> <span class="pre">v)</span></code>
components.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vertical_profiles(nz,</span> <span class="pre">z_m,</span> <span class="pre">wind,</span> <span class="pre">ustar)</span></code> – compute vertical profiles of
wind and eddy diffusivity.  Returns <code class="docutils literal notranslate"><span class="pre">(z,</span> <span class="pre">profiles)</span></code> where <code class="docutils literal notranslate"><span class="pre">profiles</span></code> is
a 5-tuple <code class="docutils literal notranslate"><span class="pre">(u,</span> <span class="pre">v,</span> <span class="pre">Kx,</span> <span class="pre">Ky,</span> <span class="pre">Kz)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">steady_state_transport_solver(srf_flx,</span> <span class="pre">z,</span> <span class="pre">profiles,</span> <span class="pre">domain,</span> <span class="pre">levels,</span> <span class="pre">...)</span></code>
– solve the advection-diffusion equation.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bldfm</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_wind_fields</span><span class="p">,</span> <span class="n">ideal_source</span><span class="p">,</span> <span class="n">steady_state_transport_solver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bldfm.pbl_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">vertical_profiles</span>

<span class="c1"># Step 1: wind components</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">compute_wind_fields</span><span class="p">(</span><span class="n">wind_speed</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">wind_dir</span><span class="o">=</span><span class="mf">270.0</span><span class="p">)</span>

<span class="c1"># Step 2: vertical profiles</span>
<span class="n">z</span><span class="p">,</span> <span class="n">profiles</span> <span class="o">=</span> <span class="n">vertical_profiles</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">meas_height</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">wind</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">ustar</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">u_prof</span><span class="p">,</span> <span class="n">v_prof</span><span class="p">,</span> <span class="n">Kx</span><span class="p">,</span> <span class="n">Ky</span><span class="p">,</span> <span class="n">Kz</span> <span class="o">=</span> <span class="n">profiles</span>

<span class="c1"># Step 3: surface flux (or use np.zeros for footprint mode)</span>
<span class="n">srf_flx</span> <span class="o">=</span> <span class="n">ideal_source</span><span class="p">((</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span> <span class="p">(</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">))</span>

<span class="c1"># Step 4: solve</span>
<span class="n">grid</span><span class="p">,</span> <span class="n">conc</span><span class="p">,</span> <span class="n">flx</span> <span class="o">=</span> <span class="n">steady_state_transport_solver</span><span class="p">(</span>
    <span class="n">srf_flx</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>See the <code class="docutils literal notranslate"><span class="pre">examples/low_level/</span></code> directory for complete scripts:
<code class="docutils literal notranslate"><span class="pre">minimal_example.py</span></code>, <code class="docutils literal notranslate"><span class="pre">footprint_example.py</span></code>, <code class="docutils literal notranslate"><span class="pre">plot_profiles.py</span></code>,
and more.  For source area analysis, see <code class="docutils literal notranslate"><span class="pre">runs/low_level/source_area_example.py</span></code>.</p>
</section>
<section id="command-line-interface">
<h2><a class="toc-backref" href="#id27" role="doc-backlink">Command-line interface</a><a class="headerlink" href="#command-line-interface" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">bldfm</span></code> CLI wraps the full workflow and calls <code class="docutils literal notranslate"><span class="pre">initialize()</span></code>
automatically:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validate a config without running the solver</span>
$<span class="w"> </span>bldfm<span class="w"> </span>run<span class="w"> </span>examples/configs/footprint.yaml<span class="w"> </span>--dry-run

<span class="c1"># Run all towers and timesteps</span>
$<span class="w"> </span>bldfm<span class="w"> </span>run<span class="w"> </span>examples/configs/multitower.yaml

<span class="c1"># Run and save footprint plots to plots/</span>
$<span class="w"> </span>bldfm<span class="w"> </span>run<span class="w"> </span>examples/configs/multitower.yaml<span class="w"> </span>--plot
</pre></div>
</div>
</section>
<section id="further-resources">
<h2><a class="toc-backref" href="#id28" role="doc-backlink">Further resources</a><a class="headerlink" href="#further-resources" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="reference.html">Quick Reference</a>: concise code snippets for common
workflows.</p></li>
<li><p><a class="reference external" href="runs.html">Example Scripts</a>: <code class="docutils literal notranslate"><span class="pre">examples/</span></code> (config-driven),
<code class="docutils literal notranslate"><span class="pre">examples/low_level/</span></code> (direct API), and <code class="docutils literal notranslate"><span class="pre">runs/manuscript/</span></code> (paper reproduction).</p></li>
<li><p><a class="reference external" href="src.html">API Reference</a>: full function signatures and docstrings.</p></li>
<li><p>Manuscript figures: <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">runs/manuscript/generate_all.py</span></code> regenerates
all paper figures.</p></li>
</ul>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="tutorial_quickstart.html" title="Previous document">Quickstart tutorial</a>
        </li>
        <li>
          <a href="reference.html" title="Next document">Quick reference</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Mark Schlutow, Ray Chew, Mathias Göckede.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/tutorial_full.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>